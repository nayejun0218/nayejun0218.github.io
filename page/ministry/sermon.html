<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>설교말씀 - The Bridge Community Church</title>
  <link rel="stylesheet" href="/style/style.css">
  <link rel="stylesheet" href="/style/page.css">
  <link rel="stylesheet" href="/style/sermon.css">
</head>
<body>
  <div id="header"></div>
  <main>
    <section class="sermon">
      <h2>설교말씀</h2>
      <div class="sermon-section-title-wrap" style="display: flex; align-items: center; justify-content: space-between;">
        <div class="sermon-section-title">창세기 강해</div>
        <button id="toggle-sermon-list" style="background:none;border:none;cursor:pointer;font-size:2rem;line-height:1;outline:none;padding:0 0.5rem;" aria-label="더보기"><span id="arrow-icon">▼</span></button>
      </div>
      <hr class="section-divider">
      <div class="sermon-series-grid" id="genesis-sermons"></div>
      <div class="sermon-section-title-wrap" style="display: flex; align-items: center; justify-content: space-between; margin-top:2.5rem;">
        <div class="sermon-section-title">1분 말씀</div>
        <button id="toggle-shorts-list" style="background:none;border:none;cursor:pointer;font-size:2rem;line-height:1;outline:none;padding:0 0.5rem;" aria-label="더보기"><span id="shorts-arrow-icon">▼</span></button>
      </div>
      <hr class="section-divider">
      <div class="sermon-series-grid" id="shorts-sermons"></div>
      <div class="sermon-section-title-wrap" style="display: flex; align-items: center; justify-content: space-between; margin-top:2.5rem;">
        <div class="sermon-section-title">특별주일 설교</div>
        <button id="toggle-special-list" style="background:none;border:none;cursor:pointer;font-size:2rem;line-height:1;outline:none;padding:0 0.5rem;" aria-label="더보기"><span id="special-arrow-icon">▼</span></button>
      </div>
      <hr class="section-divider">
      <div class="sermon-series-grid" id="special-sermons"></div>
    </section>
  </main>
  <div id="footer"></div>
  <script src="/main.js"></script>
  <script>
    fetch('/header.html')
      .then(res => res.text())
      .then(data => { document.getElementById('header').innerHTML = data; });
    fetch('/footer.html')
      .then(res => res.text())
      .then(data => { document.getElementById('footer').innerHTML = data; });

    // 창세기 강해 더보기 기능 (슬라이드 다운/업 효과)
    // DOMContentLoaded에서 updateView()를 호출하지 않도록 수정
    // fetch 후 카드 렌더링이 끝난 뒤에만 updateView()를 한 번만 호출

    // 설교 데이터 로드 (GitHub Actions로 주간 업데이트된 JSON 사용)
    async function loadSermonData() {
      try {
        const res = await fetch('/sermons.json');
        if (!res.ok) {
          throw new Error(`설교 데이터 로드 실패: ${res.status}`);
        }
        return await res.json();
      } catch (error) {
        console.error('설교 데이터 로드 실패:', error.message);
        return [];
      }
    }

    // 설교 시리즈 설정 (확장 가능한 구조)
    const sermonSeries = [
      {
        name: '창세기 강해',
        gridId: 'genesis-sermons',
        toggleId: 'toggle-sermon-list',
        arrowId: 'arrow-icon',
        initialCount: 4
      },
      {
        name: '특별주일 설교',
        gridId: 'special-sermons',
        toggleId: 'toggle-special-list',
        arrowId: 'special-arrow-icon',
        initialCount: 4
      },
      {
        name: '1분 말씀',
        gridId: 'shorts-sermons',
        toggleId: 'toggle-shorts-list',
        arrowId: 'shorts-arrow-icon',
        initialCount: 4
      }
    ];

    // 공통 더보기/접기 로직 함수
    function setupToggleLogic(series, cards) {
      const grid = document.getElementById(series.gridId);
      const btn = document.getElementById(series.toggleId);
      let expanded = false;

      function getCardHeight(n) {
        if (cards.length === 0) return 0;
        const card = cards[0];
        const style = window.getComputedStyle(grid);
        const gap = parseFloat(style.gap) || 0;
        // 한 줄에 몇 개가 들어가는지 동적으로 계산
        const cardsPerRow = Math.floor(grid.offsetWidth / card.offsetWidth) || 1;
        const rowCount = Math.ceil(n / cardsPerRow);
        const cardHeight = card.offsetHeight;
        if (cardHeight === 0) {
          return (250 + gap) * rowCount; 
        }
        return rowCount * cardHeight + (rowCount - 1) * gap + 20;
      }

      function updateView() {
        if (expanded) {
          grid.style.maxHeight = getCardHeight(cards.length) + 'px';
        } else {
          grid.style.maxHeight = getCardHeight(series.initialCount) + 'px';
        }
        btn.setAttribute('aria-label', expanded ? '접기' : '더보기');
        btn.classList.toggle('open', expanded);
      }

      // 이벤트 리스너가 중복으로 등록되지 않도록 한 번만 실행
      if (!btn.dataset.listenerAttached) {
        btn.addEventListener('click', function() {
          expanded = !expanded;
          updateView();
        });
        window.addEventListener('resize', () => updateView());
        btn.dataset.listenerAttached = 'true';
      }
      
      // 최초 설정된 개수만 보이게
      updateView();
    }

    loadSermonData().then(data => {
      // 모든 시리즈 렌더링 및 로직 적용
      sermonSeries.forEach(series => {
        const grid = document.getElementById(series.gridId);
        const seriesData = data.filter(card => card.series === series.name);
        
        // 카드 렌더링
        grid.innerHTML = seriesData.map(card => `
          <a href="${card.url}" target="_blank" class="sermon-card-link">
            <div class="sermon-card">
              <div class="sermon-thumb-wrap">
                <img class="sermon-thumb" src="${card.thumb}" alt="썸네일">
                <img class="youtube-logo" src="/images/logo/youtube-logo.png" alt="YouTube Logo">
              </div>
              <div class="sermon-info">
                <div class="sermon-title">${card.title}</div>
                <div class="sermon-date">${card.date}</div>
              </div>
              <span class="hover-text">${series.name === '1분 말씀' ? '쇼츠 바로가기' : '강해 바로가기'}</span>
            </div>
          </a>
        `).join('');

        // 더보기/접기 로직 적용
        const cards = grid.querySelectorAll('.sermon-card-link');
        if (cards.length > series.initialCount) {
          setupToggleLogic(series, cards);
        } else {
          // 설정된 개수보다 적으면 더보기 버튼 숨기기
          const btn = document.getElementById(series.toggleId);
          if (btn) btn.style.display = 'none';
        }
      });
    }).catch(error => {
      console.error('설교 데이터 로드 실패:', error);
    });
  </script>
</body>
</html> 